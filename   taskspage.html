<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Arham Insights | Premium Learning</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://www.adcash.com/script/lib.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root{--primary:#ff9933;--dark:#070b14;--card-bg:rgba(255,153,51,0.05)}
    body{margin:0;background:var(--dark);color:#fff;font-family:Poppins,sans-serif;padding-top:90px;padding-bottom:80px; overflow-x: hidden;}
    main{max-width:850px;margin:auto;padding:0 15px}
    #timer-container{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:var(--primary);color:#000;padding:12px 26px;font-weight:800;border-radius:50px;z-index:99999;box-shadow: 0 5px 15px rgba(255,153,51,0.4);}
    
    /* Music Player Style */
    #music-container{background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--primary);}
    #task-audio{width: 100%; height: 35px; filter: sepia(100%) saturate(300%) hue-rotate(10deg);}

    .premium-quote {background: linear-gradient(135deg, rgba(255,153,51,0.15), rgba(255,255,255,0.05)); border-radius: 15px; padding: 20px; margin: 20px 0; border-left: 5px solid var(--primary); font-style: italic; font-weight: 600; color: #ffd699; text-align: left;}
    #task-content p{line-height:1.8;color:#e2e8f0;font-size:1.1rem;margin-bottom:22px;}
    .ad-slot{margin:30px auto; width: 100%; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.02); border-radius:12px; border: 1px dashed rgba(255,153,51,0.1); overflow: visible; clear: both;}
    .lb-slot{min-height:110px !important;} .hp-slot{min-height:620px !important;} .mid-slot{min-height:280px;}
    #status-overlay{display:none;position:fixed;inset:0; background:rgba(7,11,20,.97); z-index:200000; align-items:center; justify-content:center; flex-direction:column}
    .loader-spin{width:45px;height:45px;border:5px solid var(--card-bg); border-top:5px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="timer-container">‚è≥ Time Bacha Hai: <span id="timer">05:00</span></div>

<div id="status-overlay">
    <div class="loader-spin"></div>
    <div style="margin-top:20px;color:var(--primary);font-weight:bold">Aapka Reward Check Ho Raha Hai...</div>
</div>

<main>
    <div class="ad-slot lb-slot" id="perm-lb"></div>

    <div class="premium-quote">"Aaj ka hardwork, kal ki success ki chabi hai." üöÄ</div>

    <div id="music-container">
        <p style="margin:0 0 10px 0; font-size: 0.8rem; font-weight: 700; color: var(--primary);">
            <i class="fa-solid fa-music"></i> Non-stop Task Mashup
        </p>
        <audio id="task-audio" controls loop>
            <source id="audio-source" src="" type="audio/mpeg">
        </audio>
    </div>

    <h2 id="task-title" style="color:var(--primary); font-weight: 800; text-align: center;">Premium Learning</h2>
    <div id="task-content"></div>

    <div class="ad-slot hp-slot" id="perm-hp"></div>
</main>

<script>
const sb=supabase.createClient("https://mkzgmrxakattqgbjnwch.supabase.co","sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL");
let taskId=new URLSearchParams(location.search).get('id')||1;
let currentUser=null;
let adSetSwitch = true;
let timeLeft = 300; 

// --- ADS POOLS ---
const AD_SET_A = [
    `<script async src="https://pl28481408.effectivegatecpm.com/b104bb133c0e3abf10d65c6dca934730/invoke.js"><\/script><div id="container-b104bb133c0e3abf10d65c6dca934730"></div>`, 
    `<script>atOptions={'key':'ac3a34c448d39282025c11644797e3a1','format':'iframe','height':50,'width':320};<\/script><script src="https://www.highperformanceformat.com/ac3a34c448d39282025c11644797e3a1/invoke.js"><\/script>`, 
    `<div id="ntv_2103430"></div><script type="text/javascript">(function(d){var p={bvwidgetid:"ntv_2103430",bvlinksownid:2103430,rows:1,cols:1,textpos:"below",imagewidth:150,mobilecols:1,cb:(new Date()).getTime()};p.bvwidgetid="ntv_2103430"+p.cb;d.getElementById("ntv_2103430").id=p.bvwidgetid;var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src="https://cdn.hyperpromote.com/bidvertiser/tags/active/bdvws.js?"+Object.keys(p).map(k=>k+'='+p[k]).join('&');d.getElementById(p.bvwidgetid).appendChild(s);})(document);<\/script>`, 
    `<script data-cfasync="false" src="//bdv.bidvertiser.com/BidVertiser.dbm?pid=941237&bid=2103430" type="text/javascript"><\/script>`, 
    `<script>aclib.runBanner({zoneId: '10825946'});<\/script>`, 
    `<div data-mndbanid="bee316ae-ffd7-4f6e-9ae9-c76867234471"></div>`, 
    `<div data-banner-id="1479032"></div>`
];

const AD_SET_B = [
    `<ins class="e300x50" data-revive-zoneid="65571"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`, 
    `<ins class="e300x250" data-revive-zoneid="65572"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`, 
    `<div data-mndazid="fd3241b3-7146-4b1d-aac0-4f35e94bb466"></div>`, 
    `<script>(function(jaknh){var d=document,s=d.createElement('script'),l=d.scripts[d.scripts.length-1];s.settings=jaknh||{};s.src="\/\/wretchedadvantage.com\/bwXAVks\/d.GXlD0KYqW_cx\/Oermb9UuIZuUKl\/kdPjTzYd3hNHTAI\/1oNOzHM\/thN\/jKcj1FM\/jfUN3INeAM";s.async=true;l.parentNode.insertBefore(s,l);})({})<\/script>`, 
    `<div id="awn-z10825986"></div><script data-cfasync="false" src="//discovernative.com/script/native_render.js"><\/script>`, 
    `<script async src="https://pl28481408.effectivegatecpm.com/b104bb133c0e3abf10d65c6dca934730/invoke.js"><\/script><div id="container-b104bb133c0e3abf10d65c6dca934730"></div>`, 
    `<script data-cfasync="false" src="//bdv.bidvertiser.com/BidVertiser.dbm?pid=941237&bid=2103430" type="text/javascript"><\/script>`
];

function safeInject(id, code) {
    const el = document.getElementById(id);
    if (!el) return;
    const range = document.createRange();
    const fragment = range.createContextualFragment(code);
    el.innerHTML = "";
    el.appendChild(fragment);
}

function refreshRotatingAds() {
    const currentPool = adSetSwitch ? AD_SET_A : AD_SET_B;
    document.querySelectorAll(".mid-slot").forEach((div, i) => {
        if(currentPool[i]) safeInject(div.id, currentPool[i]);
    });
    adSetSwitch = !adSetSwitch;
}

// --- MUSIC LOGIC (Auto-Convert GDrive Links) ---
function setupMusic(url) {
    const audio = document.getElementById('task-audio');
    if (!url) return;

    let finalUrl = url;

    // Google Drive Link detection and conversion
    if (url.includes('drive.google.com')) {
        let fileId = "";
        if (url.includes('/file/d/')) {
            fileId = url.split('/file/d/')[1].split('/')[0];
        } else if (url.includes('id=')) {
            fileId = url.split('id=')[1].split('&')[0];
        }
        
        if (fileId) {
            finalUrl = `https://docs.google.com/uc?export=open&id=${fileId}`;
        }
    }
    
    audio.src = finalUrl;
    
    const savedPos = localStorage.getItem('arham_mashup_pos');
    if (savedPos) audio.currentTime = parseFloat(savedPos);

    audio.play().catch(() => console.log("User interaction required for audio"));
    
    audio.ontimeupdate = () => {
        localStorage.setItem('arham_mashup_pos', audio.currentTime);
    };
}

async function loadContent(){
    let {data}=await sb.from('admin_blogs').select('*').eq('id',taskId).maybeSingle();
    if(data) {
        document.getElementById("task-title").innerText=data.keyword;
        const box=document.getElementById("task-content");
        const paras=data.content.split('\n').filter(x=>x.trim());
        box.innerHTML="";
        
        paras.forEach((t,i)=>{
            const p=document.createElement("p"); p.innerText=t; box.appendChild(p);
            if((i+1)%2 === 0 && document.querySelectorAll('.mid-slot').length < 7){
                const midDiv = document.createElement("div");
                midDiv.className = "ad-slot mid-slot"; midDiv.id = `mid-${i}`;
                box.appendChild(midDiv);
            }
        });
        
        safeInject('perm-lb', `<ins class="e728x90" data-revive-zoneid="65574"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`);
        safeInject('perm-hp', `<ins class="e300x600" data-revive-zoneid="65573"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`);
        
        refreshRotatingAds();
        if(data.song_url) setupMusic(data.song_url);
    }
}

function startTimer(){
    const el=document.getElementById("timer");
    const savedTime = sessionStorage.getItem('task_timer_' + taskId);
    if(savedTime) timeLeft = parseInt(savedTime);

    const iv = setInterval(()=>{ 
        if(timeLeft > 0) {
            timeLeft--;
            let m=Math.floor(timeLeft/60), s=timeLeft%60;
            el.textContent=`${m}:${s.toString().padStart(2,'0')}`; 
            sessionStorage.setItem('task_timer_' + taskId, timeLeft);
        } else { 
            clearInterval(iv); 
            sessionStorage.removeItem('task_timer_' + taskId);
            submitTask(); 
        }
    },1000);
}

// Reward Amount updated to ‚Çπ3
async function submitTask(){
    document.getElementById("status-overlay").style.display="flex";
    await sb.from('user_work').insert([{username:currentUser.email, task_id:taskId.toString(), status:'Success', amount:3}]);
    location.href="dashboard.html?status=success";
}

async function init(){
    const {data:{session}}=await sb.auth.getSession();
    if(!session){location.href="login.html";return;}
    currentUser=session.user;
    loadContent(); 
    startTimer();
    
    setInterval(() => {
        refreshRotatingAds();
        safeInject('perm-lb', `<ins class="e728x90" data-revive-zoneid="65574"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`);
        safeInject('perm-hp', `<ins class="e300x600" data-revive-zoneid="65573"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`);
    }, 40000);
}
window.onload=init;
</script>
</body>
</html>
