<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arham Insights | Premium Learning</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#ff9933;--dark:#070b14;--card-bg:rgba(255,153,51,0.05)}
        body{margin:0;background:var(--dark);color:#fff;font-family:Poppins,sans-serif;padding-top:90px;padding-bottom:80px; overflow-x: hidden;}
        main{max-width:850px;margin:auto;padding:0 15px}
        #timer-container{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:var(--primary);color:#000;padding:12px 26px;font-weight:800;border-radius:50px;z-index:99999;box-shadow: 0 5px 15px rgba(255,153,51,0.4);}
        #music-container{background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--primary);}
        #task-audio{width: 100%; height: 35px; filter: sepia(100%) saturate(300%) hue-rotate(10deg);}
        
        .ad-slot{margin:30px auto; width: 100%; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.02); border-radius:12px; border: 1px dashed rgba(255,153,51,0.2); min-height: 250px; overflow: hidden; clear: both;}
        .lb-slot { height: 90px; min-height: 90px; }
        
        #status-overlay{display:none;position:fixed;inset:0; background:rgba(7,11,20,.97); z-index:200000; align-items:center; justify-content:center; flex-direction:column}
        .loader-spin{width:45px;height:45px;border:5px solid var(--card-bg); border-top:5px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite}
        @keyframes spin{100%{transform:rotate(360deg)}}
        iframe { border: none !important; width: 300px; height: 250px; }
        .lb-slot iframe { width: 320px; height: 50px; }
    </style>
</head>
<body>

<div id="timer-container">‚è≥ Time Bacha Hai: <span id="timer">05:00</span></div>

<div id="status-overlay">
    <div class="loader-spin"></div>
    <div style="margin-top:20px;color:var(--primary);font-weight:bold">Aapka Reward Check Ho Raha Hai...</div>
</div>

<main>
    <div class="ad-slot lb-slot" id="ad-top"></div>

    <div class="premium-quote" style="background: linear-gradient(135deg, rgba(255,153,51,0.15), rgba(255,255,255,0.05)); border-radius: 15px; padding: 20px; margin: 20px 0; border-left: 5px solid var(--primary); font-style: italic; font-weight: 600; color: #ffd699;">"Aaj ka hardwork, kal ki success ki chabi hai." üöÄ</div>

    <div id="music-container">
        <p style="margin:0 0 10px 0; font-size: 0.8rem; font-weight: 700; color: var(--primary);"><i class="fa-solid fa-music"></i> Non-stop Task Mashup</p>
        <audio id="task-audio" controls loop><source id="audio-source" src="" type="audio/mpeg"></audio>
    </div>

    <h2 id="task-title" style="color:var(--primary); font-weight: 800; text-align: center;">Premium Learning</h2>
    
    <div id="task-content"></div>
    
    <div id="final-anchor-ad" class="ad-slot"></div>
</main>

<script>
const sb=supabase.createClient("https://mkzgmrxakattqgbjnwch.supabase.co","sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL");
let taskId=new URLSearchParams(location.search).get('id')||1;
let currentUser=null;
let timeLeft = 300; 

// --- NEW AD CODES ---
const NEW_MID_CODE = `
    <script type="text/javascript">
        atOptions = { 'key' : 'b885d21cc49004931f6c2a78a423c968', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
    <\/script>
    <script type="text/javascript" src="https://www.highperformanceformat.com/b885d21cc49004931f6c2a78a423c968/invoke.js"><\/script>
`;

const TOP_BANNER_CODE = `
    <script type="text/javascript">
        atOptions = { 'key' : 'ac3a34c448d39282025c11644797e3a1', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
    <\/script>
    <script type="text/javascript" src="https://www.highperformanceformat.com/ac3a34c448d39282025c11644797e3a1/invoke.js"><\/script>
`;

// --- POWER INJECTOR ---
function injectAd(containerId, htmlCode) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = "";
    const iframe = document.createElement('iframe');
    iframe.scrolling = "no";
    container.appendChild(iframe);
    
    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(`<!DOCTYPE html><html><body style="margin:0;display:flex;justify-content:center;align-items:center;background:transparent;">${htmlCode}</body></html>`);
    doc.close();
}

async function loadContent(){
    let {data}=await sb.from('admin_blogs').select('*').eq('id',taskId).maybeSingle();
    if(data) {
        document.getElementById("task-title").innerText=data.keyword;
        const box=document.getElementById("task-content");
        const paras=data.content.split('\n').filter(x=>x.trim());
        box.innerHTML="";
        
        paras.forEach((t,i)=>{
            const p=document.createElement("p"); p.innerText=t; box.appendChild(p);
            
            // Har 2nd paragraph ke baad aapka NAYA ad code
            if((i+1)%2 === 0 && i < 14){
                const midId = `mid-ad-${i}`;
                const midDiv = document.createElement("div");
                midDiv.className = "ad-slot mid-ad-unit"; 
                midDiv.id = midId;
                box.appendChild(midDiv);
                
                setTimeout(() => injectAd(midId, NEW_MID_CODE), 400 * i);
            }
        });

        // Top Banner
        injectAd('ad-top', TOP_BANNER_CODE);
        // Final Bottom Ad with your new code
        injectAd('final-anchor-ad', NEW_MID_CODE);

        // Refresh logic: Har 40s mein Middle Ads badlengi (Using New Code)
        setInterval(() => {
            document.querySelectorAll('.mid-ad-unit').forEach(div => {
                injectAd(div.id, NEW_MID_CODE);
            });
        }, 40000);

        if(data.song_url) setupMusic(data.song_url);
    }
}

// Timer & Submit stay the same (Strict ‚Çπ5 reward logic)
function startTimer(){
    const el=document.getElementById("timer");
    const iv = setInterval(()=>{ 
        if(timeLeft > 0) {
            timeLeft--;
            let m=Math.floor(timeLeft/60), s=timeLeft%60;
            el.textContent=`${m}:${s.toString().padStart(2,'0')}`; 
        } else { clearInterval(iv); submitTask(); }
    },1000);
}

async function submitTask(){
    document.getElementById("status-overlay").style.display="flex";
    await sb.from('user_work').insert([{
        username: currentUser.email, 
        task_id: taskId.toString(), 
        status: 'Success', 
        amount: 5.00,
        keyword: document.getElementById("task-title").innerText
    }]);
    location.href="dashboard.html?status=success";
}

function setupMusic(url) {
    const audio = document.getElementById('task-audio');
    let finalUrl = url;
    if (url.includes('drive.google.com')) {
        let fileId = url.split('/file/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0];
        if (fileId) finalUrl = `https://docs.google.com/uc?export=open&id=${fileId}`;
    }
    audio.src = finalUrl;
    audio.play().catch(() => console.log("User click needed"));
}

async function init(){
    const {data:{session}}=await sb.auth.getSession();
    if(!session){location.href="login.html";return;}
    currentUser=session.user;
    loadContent(); 
    startTimer();
}

window.onload = init;
</script>
</body>
</html>
