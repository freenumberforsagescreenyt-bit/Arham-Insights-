<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arham Insights | Premium Learning</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #f97316;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        /* PREMIUM REFRESHING BACKGROUND */
        body {
            margin: 0;
            padding-top: 100px;
            padding-bottom: 80px;
            overflow-x: hidden;
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            color: #ffffff;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(249, 115, 22, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(124, 58, 237, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }

        main { max-width: 800px; margin: auto; padding: 0 20px; text-align: center; }

        /* Timer Sticky */
        #timer-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: #000;
            padding: 12px 35px;
            font-weight: 800;
            border-radius: 50px;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Anti-Redirect Ad Slot */
        .ad-slot {
            margin: 40px auto;
            width: 100%;
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--glass);
            border-radius: 30px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        .lb-slot { min-height: 90px; }

        #task-content p {
            background: rgba(255, 255, 255, 0.03);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            line-height: 1.8;
            border-left: 5px solid var(--primary);
            text-align: left;
        }

        #status-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 29, 0.98);
            z-index: 200000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loader-spin {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.1);
            border-top: 6px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="timer-container">‚è≥ Time Left: <span id="timer">05:00</span></div>

<div id="status-overlay">
    <div class="loader-spin"></div>
    <p style="margin-top:20px;color:var(--primary);font-weight:bold;">Verifying Reward...</p>
</div>

<main>
    <div class="ad-slot lb-slot" id="ad-top"></div>

    <div id="music-container" style="background:rgba(0,0,0,0.3); padding:20px; border-radius:20px; margin:20px 0; border:1px solid var(--border);">
        <p style="color:var(--primary); font-weight:700; margin-bottom:10px;"><i class="fa-solid fa-music"></i> Focus Beats</p>
        <audio id="task-audio" controls loop style="width:100%;"><source id="audio-source" src="" type="audio/mpeg"></audio>
    </div>

    <h1 id="task-title" style="color:var(--primary); font-weight:800; margin-bottom:30px;"></h1>
    
    <div id="task-content"></div>
    
    <div id="final-anchor-ad" class="ad-slot"></div>
</main>

<script>
const sb = supabase.createClient("https://mkzgmrxakattqgbjnwch.supabase.co","sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL");
let taskId = new URLSearchParams(location.search).get('id') || 1;
let currentUser = null;
let timeLeft = 300; 

// --- ANTI-REDIRECT AD ENGINE ---
function forceLoadAd(containerId) {
    const container = document.getElementById(containerId);
    if(!container) return;
    
    const adCodes = [
        `<script type="text/javascript">atOptions={'key':'b885d21cc49004931f6c2a78a423c968','format':'iframe','height':250,'width':300,'params':{}};\x3C/script><script type="text/javascript" src="//www.highperformanceformat.com/b885d21cc49004931f6c2a78a423c968/invoke.js">\x3C/script>`,
        `<script type="text/javascript">atOptions={'key':'ac3a34c448d39282025c11644797e3a1','format':'iframe','height':50,'width':320,'params':{}};\x3C/script><script type="text/javascript" src="//www.highperformanceformat.com/ac3a34c448d39282025c11644797e3a1/invoke.js">\x3C/script>`
    ];

    container.innerHTML = ""; 
    const iframe = document.createElement('iframe');
    
    // SANDBOX ADDED: Isse ad load hogi par page redirect nahi kar payegi
    iframe.sandbox = "allow-scripts allow-forms allow-same-origin"; 
    iframe.style.border = "none"; 
    iframe.style.width = "100%"; 
    iframe.style.height = "100%";
    container.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    const chosenAd = container.classList.contains('lb-slot') ? adCodes[1] : adCodes[0];
    doc.write(`<html><body style="margin:0;display:flex;justify-content:center;align-items:center;">${chosenAd}</body></html>`);
    doc.close();
}

async function loadContent(){
    let {data} = await sb.from('admin_blogs').select('*').eq('id', taskId).maybeSingle();
    if(data) {
        document.getElementById("task-title").innerText = data.keyword;
        const box = document.getElementById("task-content");
        const paras = data.content.split('\n').filter(x => x.trim());
        box.innerHTML = "";
        paras.forEach((t, i) => {
            const p = document.createElement("p"); p.innerText = t; box.appendChild(p);
            if((i + 1) % 2 === 0 && i < 14){
                const midId = `mid-ad-${i}`;
                const midDiv = document.createElement("div");
                midDiv.className = "ad-slot mid-ad-unit"; 
                midDiv.id = midId; box.appendChild(midDiv);
                forceLoadAd(midId);
            }
        });
        forceLoadAd('ad-top'); forceLoadAd('final-anchor-ad');
        
        // Refresh ads every 40s to increase impressions
        setInterval(() => {
            document.querySelectorAll('.ad-slot').forEach(slot => { forceLoadAd(slot.id); });
        }, 40000);

        if(data.song_url) setupMusic(data.song_url);
    }
}

function startTimer(){
    const el = document.getElementById("timer");
    const iv = setInterval(() => { 
        if(timeLeft > 0) {
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            el.textContent = `${m}:${s.toString().padStart(2,'0')}`; 
        } else { clearInterval(iv); submitTask(); }
    }, 1000);
}

async function submitTask(){
    document.getElementById("status-overlay").style.display = "flex";
    await sb.from('user_work').insert([{
        username: currentUser.email, 
        task_id: taskId.toString(), 
        status: 'Success', 
        amount: 5.00,
        keyword: document.getElementById("task-title").innerText
    }]);
    location.href = "dashboard.html?status=success";
}

function setupMusic(url) {
    const audio = document.getElementById('task-audio');
    let finalUrl = url;
    if (url.includes('drive.google.com')) {
        let fileId = url.split('/file/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0];
        if (fileId) finalUrl = `https://docs.google.com/uc?export=open&id=${fileId}`;
    }
    audio.src = finalUrl;
    audio.play().catch(() => console.log("Click to play music"));
}

async function init(){
    const {data:{session}} = await sb.auth.getSession();
    if(!session){ location.href = "login.html"; return; }
    currentUser = session.user;
    loadContent(); startTimer();
}
window.onload = init;
</script>
</body>
</html>


