<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Arham Insights | Premium Learning</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://www.adcash.com/script/lib.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root{--primary:#ff9933;--dark:#070b14;--card-bg:rgba(255,153,51,0.05)}
    body{margin:0;background:var(--dark);color:#fff;font-family:Poppins,sans-serif;padding-top:90px;padding-bottom:80px; overflow-x: hidden;}
    main{max-width:850px;margin:auto;padding:0 15px}
    #timer-container{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:var(--primary);color:#000;padding:12px 26px;font-weight:800;border-radius:50px;z-index:99999;box-shadow: 0 5px 15px rgba(255,153,51,0.4);}
    #music-container{background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--primary);}
    #task-audio{width: 100%; height: 35px; filter: sepia(100%) saturate(300%) hue-rotate(10deg);}
    .ad-slot{margin:30px auto; width: 100%; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.02); border-radius:12px; border: 1px dashed rgba(255,153,51,0.1); overflow: visible; clear: both; min-height: 100px; color: #64748b; font-size: 0.8rem; text-align: center; font-weight: bold;}
    .lb-slot{min-height:110px !important;} .hp-slot{min-height:620px !important;} .mid-slot{min-height:280px;}
    #status-overlay{display:none;position:fixed;inset:0; background:rgba(7,11,20,.97); z-index:200000; align-items:center; justify-content:center; flex-direction:column}
    .loader-spin{width:45px;height:45px;border:5px solid var(--card-bg); border-top:5px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="timer-container">‚è≥ Time Bacha Hai: <span id="timer">05:00</span></div>

<div id="status-overlay">
    <div class="loader-spin"></div>
    <div style="margin-top:20px;color:var(--primary);font-weight:bold">Aapka Reward Check Ho Raha Hai...</div>
</div>

<main>
    <div class="ad-slot lb-slot" id="perm-lb">Premium Ads Syncing...</div>

    <div class="premium-quote" style="background: linear-gradient(135deg, rgba(255,153,51,0.15), rgba(255,255,255,0.05)); border-radius: 15px; padding: 20px; margin: 20px 0; border-left: 5px solid var(--primary); font-style: italic; font-weight: 600; color: #ffd699;">"Aaj ka hardwork, kal ki success ki chabi hai." üöÄ</div>

    <div id="music-container">
        <p style="margin:0 0 10px 0; font-size: 0.8rem; font-weight: 700; color: var(--primary);"><i class="fa-solid fa-music"></i> Non-stop Task Mashup</p>
        <audio id="task-audio" controls loop><source id="audio-source" src="" type="audio/mpeg"></audio>
    </div>

    <h2 id="task-title" style="color:var(--primary); font-weight: 800; text-align: center;">Premium Learning</h2>
    <div id="task-content"></div>

    <div class="ad-slot hp-slot" id="perm-hp">High-Value Ads Syncing...</div>
</main>

<script>
const sb=supabase.createClient("https://mkzgmrxakattqgbjnwch.supabase.co","sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL");
let taskId=new URLSearchParams(location.search).get('id')||1;
let currentUser=null;
let timeLeft = 300; 

const AD_RESOURCES = [
    `<script async src="https://pl28481408.effectivegatecpm.com/b104bb133c0e3abf10d65c6dca934730/invoke.js"><\/script><div id="container-b104bb133c0e3abf10d65c6dca934730"></div>`,
    `<script>atOptions={'key':'ac3a34c448d39282025c11644797e3a1','format':'iframe','height':50,'width':320};<\/script><script src="https://www.highperformanceformat.com/ac3a34c448d39282025c11644797e3a1/invoke.js"><\/script>`,
    `<ins class="e300x250" data-revive-zoneid="65572"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`,
    `<script>if(window.aclib){aclib.runBanner({zoneId: '10825946'});}<\/script>`,
    `<div id="ntv_2103430"></div><script type="text/javascript">(function(d){var p={bvwidgetid:"ntv_2103430",bvlinksownid:2103430,rows:1,cols:1,textpos:"below",imagewidth:150,mobilecols:1,cb:(new Date()).getTime()};p.bvwidgetid="ntv_2103430"+p.cb;d.getElementById("ntv_2103430").id=p.bvwidgetid;var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src="https://cdn.hyperpromote.com/bidvertiser/tags/active/bdvws.js?"+Object.keys(p).map(k=>k+'='+p[k]).join('&');d.getElementById(p.bvwidgetid).appendChild(s);})(document);<\/script>`
];

// --- CRITICAL ATOMIC INJECTOR ---
function atomicInject(id, code) {
    const el = document.getElementById(id);
    if (!el) return;
    
    // Clear Slot
    el.innerHTML = "";
    const container = document.createElement('div');
    container.innerHTML = code;
    
    // In-place script re-execution to prevent Head Bloat
    const scripts = container.querySelectorAll("script");
    scripts.forEach(oldS => {
        const newS = document.createElement("script");
        Array.from(oldS.attributes).forEach(a => newS.setAttribute(a.name, a.value));
        if (oldS.innerHTML) newS.innerHTML = oldS.innerHTML;
        // Injecting directly into the container instead of head
        oldS.parentNode.replaceChild(newS, oldS);
    });
    
    el.appendChild(container);

    // Immediate Recovery if Ad Fails to Render
    setTimeout(() => {
        if (el.offsetHeight < 40) {
            const fallback = AD_RESOURCES[Math.floor(Math.random() * AD_RESOURCES.length)];
            atomicInject(id, fallback);
        }
    }, 5000);
}

function refreshAllAds() {
    // 1. Force Permanent Ads
    atomicInject('perm-lb', `<ins class="e728x90" data-revive-zoneid="65574"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`);
    atomicInject('perm-hp', `<ins class="e300x600" data-revive-zoneid="65573"></ins><script async src="//network.eonads.com/adserver/www/delivery/asyncjs.php"><\/script>`);

    // 2. Middle Slots
    document.querySelectorAll(".mid-slot").forEach((div, i) => {
        atomicInject(div.id, AD_RESOURCES[i % AD_RESOURCES.length]);
    });
}

async function loadContent(){
    let {data}=await sb.from('admin_blogs').select('*').eq('id',taskId).maybeSingle();
    if(data) {
        document.getElementById("task-title").innerText=data.keyword;
        const box=document.getElementById("task-content");
        const paras=data.content.split('\n').filter(x=>x.trim());
        box.innerHTML="";
        paras.forEach((t,i)=>{
            const p=document.createElement("p"); p.innerText=t; box.appendChild(p);
            if((i+1)%2 === 0 && i < 14){
                const midDiv = document.createElement("div");
                midDiv.className = "ad-slot mid-slot"; midDiv.id = `mid-${i}`;
                midDiv.innerText = "Syncing Ad...";
                box.appendChild(midDiv);
            }
        });
        
        refreshAllAds(); // Immediate Start
        if(data.song_url) setupMusic(data.song_url);
    }
}

// --- MUSIC, TIMER & SUBMIT ---
function setupMusic(url) {
    const audio = document.getElementById('task-audio');
    let finalUrl = url;
    if (url.includes('drive.google.com')) {
        let fileId = url.split('/file/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0];
        if (fileId) finalUrl = `https://docs.google.com/uc?export=open&id=${fileId}`;
    }
    audio.src = finalUrl;
    const savedPos = localStorage.getItem('arham_mashup_pos');
    if (savedPos) audio.currentTime = parseFloat(savedPos);
    audio.play().catch(() => console.log("User Interaction Required"));
    audio.ontimeupdate = () => localStorage.setItem('arham_mashup_pos', audio.currentTime);
}

function startTimer(){
    const el=document.getElementById("timer");
    const savedTime = sessionStorage.getItem('task_timer_' + taskId);
    if(savedTime) timeLeft = parseInt(savedTime);
    const iv = setInterval(()=>{ 
        if(timeLeft > 0) {
            timeLeft--;
            let m=Math.floor(timeLeft/60), s=timeLeft%60;
            el.textContent=`${m}:${s.toString().padStart(2,'0')}`; 
            sessionStorage.setItem('task_timer_' + taskId, timeLeft);
        } else { clearInterval(iv); sessionStorage.removeItem('task_timer_' + taskId); submitTask(); }
    },1000);
}

async function submitTask(){
    document.getElementById("status-overlay").style.display="flex";
    await sb.from('user_work').insert([{username:currentUser.email, task_id:taskId.toString(), status:'Success', amount:3}]);
    location.href="dashboard.html?status=success";
}

async function init(){
    const {data:{session}}=await sb.auth.getSession();
    if(!session){location.href="login.html";return;}
    currentUser=session.user;
    loadContent(); startTimer();
    // Refresh only middle slots every 40s to prevent permanent ad flickering
    setInterval(() => {
        document.querySelectorAll(".mid-slot").forEach((div, i) => {
            atomicInject(div.id, AD_RESOURCES[Math.floor(Math.random() * AD_RESOURCES.length)]);
        });
    }, 40000);
}
window.onload=init;
</script>
</body>
</html>
