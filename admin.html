<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control - Arham Insights</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #ff9933; --success: #27ae60; --dark-bg: #2c3e50; --danger: #e74c3c; --info: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--dark-bg); color: white; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        .login-box, .dashboard { background: white; color: #333; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 95%; max-width: 1100px; margin: 20px 0; }
        .dashboard { display: none; }
        
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; margin-bottom: 10px; font-size: 0.9em; }
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; position: sticky; top: 0; background: white; z-index: 10; padding: 10px 0; border-bottom: 2px solid #eee; }
        .nav-tabs div { cursor: pointer; padding: 10px 15px; background: #eee; border-radius: 5px; flex: 1; text-align: center; font-size: 0.85em; font-weight: bold; }
        .nav-tabs .active-tab { background: var(--primary); color: white; }
        
        .tab-content { display: none; }
        .active { display: block; }
        
        .list-container { max-height: 600px; overflow-y: auto; border: 1px solid #eee; margin-top: 15px; padding: 10px; border-radius: 8px; background: #fafafa; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; color: #333; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 5; }

        .search-bar { margin-bottom: 15px; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; outline: none; width: 100%; box-sizing: border-box;}

        .blog-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #ddd; background: white; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .copy-icon { cursor: pointer; color: var(--primary); margin-left: 15px; font-size: 1.2em; }
        .delete-icon { cursor: pointer; color: var(--danger); margin-left: 15px; }
        
        .status-badge { font-size: 0.7em; padding: 3px 8px; border-radius: 12px; font-weight: bold; text-transform: uppercase; }
        .status-pending { background: #fff3e0; color: #ef6c00; }
        .status-approved { background: #e8f5e9; color: #2e7d32; }

        .action-btn { padding: 5px 10px; font-size: 0.8em; margin-right: 5px; border-radius: 4px; border:none; color:white; cursor:pointer; }
        .danger-zone { margin-top: 20px; padding: 15px; border: 2px solid var(--danger); border-radius: 10px; background: #fff5f5; text-align: left; }
    </style>
</head>
<body>

    <div class="login-box" id="login-box">
        <h2 style="color: var(--primary); text-align: center;"><i class="fa fa-shield-alt"></i> Admin Login</h2>
        <input type="password" id="access-code" placeholder="Enter Secret Key...">
        <button onclick="checkAccess()" style="width:100%;">Login</button>
    </div>

    <div class="dashboard" id="main-dashboard">
        <div style="display:flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 15px;">
            <h2 style="margin:0; color: var(--dark-bg);">Arham Control Center</h2>
            <div>
                <span id="task-total-count" style="background:var(--primary); color:white; padding:5px 10px; border-radius:15px; font-size:0.8em; margin-right:10px;">Tasks: 0</span>
                <button onclick="logout()" style="background:#555; padding: 8px 15px;">Logout</button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="active-tab" onclick="showTab(event, 'verify-work')">Submissions</div>
            <div onclick="showTab(event, 'blogs')">Single Task</div>
            <div onclick="showTab(event, 'keywords')">Bulk Upload (SEO)</div>
        </div>

        <div id="verify-work" class="tab-content active">
            <div style="display:flex; justify-content: space-between; align-items: center; gap:10px; margin-bottom:10px;">
                <input type="text" id="sub-search" class="search-bar" placeholder="Search by Email or Code..." onkeyup="filterSubmissions()">
                <button onclick="fetchSubmissions()" style="background:var(--info); height:45px;"><i class="fa fa-sync"></i></button>
            </div>
            <div class="list-container">
                <table>
                    <thead>
                        <tr><th>Worker</th><th>Code</th><th>Status</th><th>Action</th></tr>
                    </thead>
                    <tbody id="submission-list"></tbody>
                </table>
            </div>
        </div>

        <div id="blogs" class="tab-content">
            <h3>Publish SEO Optimized Task</h3>
            <input type="text" id="blog-title" placeholder="Main Title (e.g. Best Stocks to Buy)">
            <input type="text" id="blog-keyword" placeholder="Base Keyword (Auto Arham Insights sync)">
            <textarea id="blog-content" rows="6" placeholder="Article Content..."></textarea>
            <button id="singlePublishBtn" onclick="saveBlogToSupabase()" style="width:100%;">Publish & Sync Now</button>
        </div>

        <div id="keywords" class="tab-content">
            <h3>Bulk Upload (SEO Optimized)</h3>
            <p style="font-size: 0.85em; color: #d35400; font-weight: bold;">Unique links generate karne ke liye keywords daalein.</p>
            <textarea id="keywords-input" rows="10" placeholder="Keyword 1&#10;Keyword 2..."></textarea>
            <button onclick="bulkSaveKeywords()" id="bulkBtn" style="width:100%; background: var(--success); font-size: 1.1em;">Generate 100+ Unique Links</button>

            <h3 style="margin-top:25px;">Live Tasks Links (taskspage)</h3>
            <input type="text" id="blog-search" class="search-bar" placeholder="Search Live Tasks..." onkeyup="filterBlogs()">
            <div class="list-container" id="live-links-copy-list"></div>

            <div class="danger-zone">
                <h4 style="color:var(--danger); margin-top:0;"><i class="fa fa-exclamation-triangle"></i> Danger Zone</h4>
                <p style="font-size: 0.8em; color: #333;">Sabhi purane blogs aur links ko ek saath delete karne ke liye niche button dabayein.</p>
                <button onclick="deleteAllBlogs()" style="background:var(--danger); font-size: 0.8em; padding: 8px 15px;">Delete All Live Tasks</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://mkzgmrxakattqgbjnwch.supabase.co"; 
        const SUPABASE_KEY = "sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL"; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const SECRET_CODE = "Jainam Jayati Shasnam";

        let allBlogs = [];
        let allSubmissions = [];

        function checkAccess() {
            if(document.getElementById('access-code').value === SECRET_CODE) {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                fetchBlogs();
                fetchSubmissions();
            } else { alert("Incorrect Admin Key!"); }
        }

        async function fetchSubmissions() {
            const { data, error } = await _supabase.from('tasks').select('*').order('created_at', {ascending: false});
            if(data) { allSubmissions = data; renderSubmissions(allSubmissions); }
        }

        function renderSubmissions(data) {
            const list = document.getElementById('submission-list');
            list.innerHTML = "";
            data.forEach(s => {
                const statusClass = `status-${s.status}`;
                list.innerHTML += `<tr>
                    <td>${s.worker_email}</td>
                    <td><code>${s.task_code}</code></td>
                    <td><span class="status-badge ${statusClass}">${s.status}</span></td>
                    <td>
                        ${s.status !== 'approved' ? `<button class="action-btn" style="background:var(--success)" onclick="updateStatus('${s.id}', 'approved')">Approve</button>` : ''}
                        <button class="action-btn" style="background:var(--danger)" onclick="deleteSubmission('${s.id}')">Delete</button>
                    </td>
                </tr>`;
            });
        }

        function filterSubmissions() {
            const q = document.getElementById('sub-search').value.toLowerCase();
            const filtered = allSubmissions.filter(s => s.worker_email.toLowerCase().includes(q) || s.task_code.toLowerCase().includes(q));
            renderSubmissions(filtered);
        }

        async function updateStatus(id, status) {
            await _supabase.from('tasks').update({ status: status }).eq('id', id);
            fetchSubmissions();
        }

        async function deleteSubmission(id) {
            if(confirm("Permanently delete?")) { await _supabase.from('tasks').delete().eq('id', id); fetchSubmissions(); }
        }

        async function fetchBlogs() {
            const { data } = await _supabase.from('admin_blogs').select('*').order('created_at', {ascending: false});
            if(data) {
                allBlogs = data;
                document.getElementById('task-total-count').innerText = "Tasks: " + data.length;
                renderBlogs(allBlogs);
            }
        }

        function renderBlogs(data) {
            const list = document.getElementById('live-links-copy-list');
            list.innerHTML = "";
            
            // Get current path for taskspage.html
            const loc = window.location.href;
            const path = loc.substring(0, loc.lastIndexOf('/'));
            const taskPageUrl = `${path}/taskspage.html`;

            data.forEach(b => {
                // GENERATING UNIQUE LINK WITH ID
                const fullUrl = `${taskPageUrl}?id=${b.id}`;
                list.innerHTML += `<div class="blog-item">
                    <div style="flex:1">
                        <b>${b.title}</b> <br>
                        <small style="color:var(--primary); font-weight:bold;">Keyword: ${b.keyword}</small>
                    </div>
                    <div>
                        <i class="fa fa-copy copy-icon" title="Copy Unique Link" onclick="copyText('${fullUrl}')"></i>
                        <i class="fa fa-trash delete-icon" title="Delete Task" onclick="deleteBlog('${b.id}')"></i>
                    </div>
                </div>`;
            });
        }

        function filterBlogs() {
            const q = document.getElementById('blog-search').value.toLowerCase();
            const filtered = allBlogs.filter(b => b.title.toLowerCase().includes(q) || b.keyword.toLowerCase().includes(q));
            renderBlogs(filtered);
        }

        async function saveBlogToSupabase() {
            const btn = document.getElementById('singlePublishBtn');
            const rawTitle = document.getElementById('blog-title').value.trim();
            const rawKeyword = document.getElementById('blog-keyword').value.trim();
            const content = document.getElementById('blog-content').value.trim();

            if(!rawTitle || !rawKeyword) return alert("Title & Keyword are required!");

            const seoTitle = `${rawTitle} | Arham Insights`;
            const seoKeyword = `${rawKeyword} Arham Insights`;

            btn.disabled = true; btn.innerText = "Syncing...";

            const { error } = await _supabase.from('admin_blogs').insert([{ 
                title: seoTitle, 
                keyword: seoKeyword, 
                content: content || `Latest updates on ${rawTitle}. Full guide for 2026.` 
            }]);

            if(!error) {
                alert("Published & Unique Link Generated!");
                document.getElementById('blog-title').value = "";
                document.getElementById('blog-keyword').value = "";
                document.getElementById('blog-content').value = "";
                fetchBlogs();
            } else { alert("Error: " + error.message); }
            
            btn.disabled = false; btn.innerText = "Publish & Sync Now";
        }

        async function bulkSaveKeywords() {
            const btn = document.getElementById('bulkBtn');
            const input = document.getElementById('keywords-input').value;
            const keywords = input.split('\n').map(k => k.trim()).filter(k => k !== "");
            
            if(keywords.length === 0) return alert("Enter some keywords!");
            
            btn.disabled = true;
            btn.innerText = "Generating Unique Links...";

            const rows = keywords.map(kw => ({ 
                title: `${kw} (2026 Update) | Arham Insights`, 
                keyword: `${kw} Arham Insights`, 
                content: `Everything you need to know about ${kw}. Read this complete guide by Arham Insights.` 
            }));

            const { error } = await _supabase.from('admin_blogs').insert(rows);
            if(!error) {
                alert("Successfully Synced " + keywords.length + " Unique Tasks!");
                document.getElementById('keywords-input').value = "";
                fetchBlogs();
            } else { alert("Error: " + error.message); }
            
            btn.disabled = false;
            btn.innerText = "Generate 100+ Unique Links";
        }

        async function deleteBlog(id) {
            if(confirm("Delete this blog task?")) { 
                await _supabase.from('admin_blogs').delete().eq('id', id); 
                fetchBlogs(); 
            }
        }

        // NEW: DELETE ALL FUNCTION
        async function deleteAllBlogs() {
            if(confirm("ARE YOU SURE? Ye saare live tasks aur links ko permanently delete kar dega!")) {
                const { error } = await _supabase.from('admin_blogs').delete().neq('title', 'placeholder_force_delete');
                if(!error) {
                    alert("All Tasks Deleted!");
                    fetchBlogs();
                } else { alert("Error: " + error.message); }
            }
        }

        function copyText(t) { 
            navigator.clipboard.writeText(t).then(() => {
                alert("Unique Link Copied Successfully!");
            }).catch(err => {
                alert("Manual Copy: " + t);
            });
        }
        
        function showTab(e, id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tabs div').forEach(t => t.classList.remove('active-tab'));
            document.getElementById(id).classList.add('active');
            e.currentTarget.classList.add('active-tab');
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>

