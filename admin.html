<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Elite Admin - RGB Master Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { 
            --primary: #ff9933; --dark: #0f172a; --success: #22c55e; 
            --danger: #ef4444; --accent: #6366f1; --tg-color: #0088cc;
            --glass: rgba(255, 255, 255, 0.05);
        }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; background: #0b0f1a;
            margin: 0; color: #f8fafc; padding-bottom: 50px; min-height: 100vh; overflow-x: hidden;
        }
        body::before {
            content: ""; position: fixed; inset: 0;
            background: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        /* --- THREE LINES DROPDOWN MENU --- */
        .menu-trigger { position: fixed; top: 20px; left: 20px; z-index: 2001; background: var(--primary); color: white; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-weight: 800; box-shadow: 0 5px 20px rgba(255,153,51,0.4); display: flex; align-items: center; gap: 10px; }
        .side-menu { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: #0f172a; z-index: 2000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); padding-top: 90px; border-right: 1px solid var(--glass); box-shadow: 10px 0 40px rgba(0,0,0,0.6); }
        .side-menu.active { left: 0; }
        .menu-item { padding: 18px 30px; font-weight: 700; cursor: pointer; border-bottom: 1px solid var(--glass); transition: 0.3s; color: #cbd5e1; display: flex; align-items: center; gap: 15px; }
        .menu-item:hover { background: var(--glass); color: var(--primary); padding-left: 40px; }
        .menu-item.active { background: var(--primary); color: white; }

        /* Stats & Header */
        .header { background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); color: white; padding: 25px; text-align: center; font-size: 1.6rem; font-weight: 800; border-bottom: 3px solid var(--primary); position: sticky; top: 0; z-index: 100; letter-spacing: 1px; }
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--glass); padding: 25px; border-radius: 20px; text-align: center; border-top: 4px solid var(--primary); backdrop-filter: blur(10px); }

        /* Components */
        .card { background: var(--glass); backdrop-filter: blur(20px); padding: 30px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Login & Pass Box Fix */
        #login-overlay { position: fixed; inset: 0; background: var(--dark); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .pass-box { position: relative; width: 100%; margin: 20px 0; }
        .pass-box input { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid var(--glass); background: rgba(0,0,0,0.4); color: white; text-align: center; outline: none; font-size: 1.1rem; }
        .eye-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--primary); font-size: 1.3rem; z-index: 10; }

        input, textarea, select { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--glass); background: rgba(0,0,0,0.3); color: white; outline: none; box-sizing: border-box; }
        .btn-p { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: 800; width: 100%; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-p:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255,153,51,0.4); }

        /* Modal History Fix */
        #user-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 5000; }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="card" style="width: 380px; text-align: center;">
            <h1 style="color:var(--primary); margin-bottom: 10px;">ARHAM ADMIN</h1>
            <p style="color:#94a3b8; font-size: 0.8rem;">Enter Secret Key to Access</p>
            <div class="pass-box">
                <input type="password" id="admin-pass" placeholder="••••••••">
                <i class="fa fa-eye eye-btn" id="eye-icon" onclick="togglePass()"></i>
            </div>
            <button onclick="checkAuth()" class="btn-p">ACCESS CONTROL</button>
        </div>
    </div>

    <div class="menu-trigger" onclick="toggleMenu()"><i class="fa fa-bars"></i> MENU</div>

    <div class="side-menu" id="side-menu">
        <div class="menu-item active" onclick="switchTab(event, 't-create')"><i class="fa fa-plus-circle"></i> Add Tasks</div>
        <div class="menu-item" onclick="switchTab(event, 't-grey')"><i class="fa fa-rocket"></i> Grey Market</div>
        <div class="menu-item" onclick="switchTab(event, 't-manage')"><i class="fa fa-tasks"></i> Manage Work</div>
        <div class="menu-item" onclick="switchTab(event, 't-users')"><i class="fa fa-users"></i> User History</div>
        <div class="menu-item" onclick="switchTab(event, 't-payout')"><i class="fa fa-wallet"></i> Payout Info</div>
        <div class="menu-item" onclick="switchTab(event, 't-billing')"><i class="fa fa-file-invoice"></i> Billing PDF</div>
    </div>

    <div id="admin-app" style="display:none;">
        <div class="header">ARHAM <span style="color:var(--primary)">ELITE</span> CONTROL</div>
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card"><h4>Users</h4><p id="s-users" style="font-size:1.8rem; font-weight:900;">0</p></div>
                <div class="stat-card"><h4>Standard Tasks</h4><p id="s-tasks" style="font-size:1.8rem; font-weight:900; color:var(--accent);">0</p></div>
                <div class="stat-card" style="border-color:var(--tg-color);"><h4>Grey Leads</h4><p id="s-grey" style="font-size:1.8rem; font-weight:900; color:var(--tg-color);">0</p></div>
            </div>

            <div id="t-create" class="tab-content active">
                <div class="card">
                    <h3 id="std-title" style="color:var(--primary)">Publish New Standard Task</h3>
                    <input type="hidden" id="edit-std-id">
                    <input type="text" id="std-kw" placeholder="Keyword Name">
                    <textarea id="std-content" rows="4" placeholder="Instructions for users..."></textarea>
                    <input type="text" id="std-url" placeholder="Redirect URL Link">
                    <button onclick="saveStdTask()" id="std-btn" class="btn-p">Publish Live</button>
                    <button onclick="resetStd()" id="std-cancel" style="display:none; background:#444; margin-top:10px;" class="btn-p">Cancel Edit</button>
                </div>
            </div>

            <div id="t-grey" class="tab-content">
                <div class="card" style="border-left: 6px solid var(--tg-color);">
                    <h3 style="color:var(--tg-color)">Post Premium (Grey) Task</h3>
                    <input type="hidden" id="edit-grey-id">
                    <input type="text" id="grey-name" placeholder="Work Title (e.g. Gmail)">
                    <textarea id="grey-inst" rows="4" placeholder="Telegram Submission Instructions..."></textarea>
                    <input type="number" id="grey-rew" placeholder="User Reward Amount ₹">
                    <button onclick="saveGreyTask()" class="btn-p" style="background:var(--tg-color)">Live to Grey Section</button>
                </div>
            </div>

            <div id="t-manage" class="tab-content">
                <div class="card">
                    <h3 style="color:var(--primary)">Standard Task History</h3>
                    <div id="list-std"></div>
                </div>
                <div class="card" style="border-top:5px solid var(--tg-color)">
                    <h3 style="color:var(--tg-color)">Premium Task History</h3>
                    <div id="list-grey"></div>
                </div>
            </div>

            <div id="t-users" class="tab-content">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">All Enrolled Users</h3>
                    <div style="overflow-x:auto;">
                        <table style="width:100%; text-align: left;">
                            <thead><tr style="color:var(--primary)"><th>Email</th><th>WhatsApp</th><th>Details</th></tr></thead>
                            <tbody id="user-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="t-payout" class="tab-content">
                <div class="card">
                    <h3>Payout Settlement</h3>
                    <input type="email" id="p-email" placeholder="User Email">
                    <input type="number" id="p-amount" placeholder="Amount to Add ₹">
                    <button onclick="addPayout()" class="btn-p" style="background:var(--success)">Confirm Update</button>
                </div>
            </div>

            <div id="t-billing" class="tab-content">
                <div class="card">
                    <h3>Professional Invoice</h3>
                    <input type="text" id="bill-name" placeholder="Client Name">
                    <input type="number" id="bill-qty" placeholder="Quantity" oninput="calcBill()">
                    <input type="number" id="bill-rate" value="0.10" oninput="calcBill()">
                    <h2 id="bill-total-view" style="text-align:center; color:var(--primary); font-size: 2.5rem;">₹0.00</h2>
                    <button onclick="generateProfessionalPDF()" class="btn-p" style="background:var(--accent)">Download PDF Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <div id="user-modal">
        <div class="card" style="width: 90%; max-width: 450px; text-align: center; border: 2px solid var(--primary);">
            <h2 id="modal-email" style="color:var(--primary); margin:0;">User Insights</h2>
            <hr style="border: 0.5px solid var(--glass); margin: 15px 0;">
            <div id="modal-data" style="margin: 25px 0; font-size: 1.1rem; line-height: 2.5; text-align: left; padding: 0 20px;"></div>
            <button onclick="document.getElementById('user-modal').style.display='none'" class="btn-p" style="background:#444;">CLOSE INSIGHTS</button>
        </div>
    </div>
    <script>
    const _supabase = supabase.createClient("https://mkzgmrxakattqgbjnwch.supabase.co", "sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL");
    const SECRET = "Jainam Jayati Shasnam";

    // SIDEBAR MENU TOGGLE
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('active'); }

    // EYE BUTTON FIX
    function togglePass() {
        const inp = document.getElementById('admin-pass');
        const icon = document.getElementById('eye-icon');
        if(inp.type === "password"){ 
            inp.type="text"; 
            icon.classList.replace('fa-eye','fa-eye-slash'); 
        } else { 
            inp.type="password"; 
            icon.classList.replace('fa-eye-slash','fa-eye'); 
        }
    }

    function checkAuth() {
        if(document.getElementById('admin-pass').value === SECRET) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-app').style.display = 'block';
            loadData();
        } else { alert("Unauthorized! Wrong Secret Key."); }
    }

    // SYNC & LOAD DATA (LIVE)
    async function loadData() {
        const {data:tasks} = await _supabase.from('admin_blogs').select('*').order('id',{ascending:false});
        const {data:grey} = await _supabase.from('grey_tasks').select('*').order('id',{ascending:false});
        const {data:profiles} = await _supabase.from('profiles').select('*');

        document.getElementById('s-users').innerText = profiles ? profiles.length : 0;
        document.getElementById('s-tasks').innerText = tasks ? tasks.length : 0;
        document.getElementById('s-grey').innerText = grey ? grey.length : 0;

        // Render Manage Lists
        document.getElementById('list-std').innerHTML = tasks.map(t => `
            <div style="display:flex; justify-content:space-between; padding:15px; background:rgba(255,255,255,0.05); margin-bottom:8px; border-radius:12px;">
                <span><b>${t.keyword}</b></span>
                <div>
                    <button onclick="editStd(${t.id},'${t.keyword}','${t.content.replace(/\n/g,' ')}','${t.song_url}')" style="background:var(--accent); border:none; color:white; padding:6px 12px; border-radius:6px; cursor:pointer;">Edit</button>
                    <button onclick="deleteData('admin_blogs',${t.id})" style="background:var(--danger); border:none; color:white; padding:6px 12px; border-radius:6px; cursor:pointer; margin-left:5px;">Del</button>
                </div>
            </div>
        `).join('');

        // Render User List
        document.getElementById('user-list').innerHTML = profiles.map(u => `
            <tr>
                <td>${u.email}</td><td>${u.whatsapp||'N/A'}</td>
                <td><button onclick="showUserHistory('${u.email}')" style="background:var(--primary); border:none; color:white; padding:7px 15px; border-radius:8px; cursor:pointer; font-weight:800;">VIEW HISTORY</button></td>
            </tr>
        `).join('');
    }

    // USER HISTORY MODAL (RESTORED)
    async function showUserHistory(email) {
        document.getElementById('user-modal').style.display = 'flex';
        document.getElementById('modal-email').innerText = email;
        const {data:w} = await _supabase.from('user_work').select('*').eq('username',email);
        const {data:p} = await _supabase.from('payouts').select('*').eq('email',email);
        
        let earned = w?.reduce((s,x)=>s+parseFloat(x.amount),0)||0;
        let paid = p?.reduce((s,x)=>s+parseFloat(x.amount),0)||0;
        
        document.getElementById('modal-data').innerHTML = `
            <p>Total Revenue: <b style="color:var(--success)">₹${earned.toFixed(2)}</b></p>
            <p>Total Paid: <b style="color:var(--accent)">₹${paid.toFixed(2)}</b></p>
            <p>Current Balance: <b style="color:var(--primary); font-size:1.5rem;">₹${(earned-paid).toFixed(2)}</b></p>
        `;
    }

    // TAB SWITCH LOGIC
    function switchTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(e) e.currentTarget.classList.add('active');
        if(window.innerWidth < 800) toggleMenu(); // Auto-close sidebar on mobile
    }

    // SAVE FUNCTIONS
    async function saveStdTask() {
        const id = document.getElementById('edit-std-id').value;
        const obj = { keyword: document.getElementById('std-kw').value, content: document.getElementById('std-content').value, song_url: document.getElementById('std-url').value };
        if(id) await _supabase.from('admin_blogs').update(obj).eq('id',id);
        else await _supabase.from('admin_blogs').insert([obj]);
        alert("Standard Task Live!"); loadData();
    }

    async function saveGreyTask() {
        const id = document.getElementById('edit-grey-id').value;
        const obj = { title: document.getElementById('grey-name').value, instruction: document.getElementById('grey-inst').value, reward_amount: document.getElementById('grey-rew').value };
        if(id) await _supabase.from('grey_tasks').update(obj).eq('id',id);
        else await _supabase.from('grey_tasks').insert([obj]);
        alert("Premium Task Live!"); loadData();
    }

    async function deleteData(table, id) {
        if(confirm("Confirm Delete? This cannot be undone.")) { await _supabase.from(table).delete().eq('id',id); loadData(); }
    }

    async function addPayout() {
        const email = document.getElementById('p-email').value;
        const amount = document.getElementById('p-amount').value;
        await _supabase.from('payouts').insert([{email, amount}]);
        alert("Payout Successfully Updated!"); loadData();
    }

    function calcBill() { const q=document.getElementById('bill-qty').value; const r=document.getElementById('bill-rate').value; document.getElementById('bill-total-view').innerText="₹"+(q*r).toFixed(2); }
</script>
</body>
</html>
