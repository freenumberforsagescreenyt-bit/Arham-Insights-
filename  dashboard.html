<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Arham Insights</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary: #ff9933; --dark: #0f172a; --bg: #f8fafc; --success: #22c55e; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: #1e293b; margin: 0; padding-bottom: 50px; }
        
        .navbar { background: var(--dark); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .container { max-width: 700px; margin: 20px auto; padding: 0 15px; }

        .welcome-card { background: linear-gradient(135deg, var(--dark) 0%, #1e293b 100%); color: white; padding: 30px; border-radius: 24px; margin-bottom: 25px; position: relative; overflow: hidden; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center; }
        .stat-item b { font-size: 1.4rem; color: var(--primary); display: block; }

        .glass-panel { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { font-weight: 800; font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .section-title i { color: var(--primary); }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #64748b; }
        .input-group input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #f1f5f9; background: #f8fafc; font-size: 1rem; transition: 0.3s; }
        .input-group input:read-only { background: #e2e8f0; color: #475569; border-color: #cbd5e0; cursor: not-allowed; }

        .btn-save { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3); }
        .btn-edit { background: white; color: var(--dark); border: 2px solid var(--dark); width: 100%; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; display: none; transition: 0.3s; }

        .task-grid { display: grid; gap: 15px; }
        .task-item { background: white; padding: 20px; border-radius: 20px; border: 1px solid #f1f5f9; display: flex; flex-direction: column; gap: 10px; }
        .do-btn { flex: 1; background: var(--primary); color: white; padding: 12px; border-radius: 10px; text-decoration: none; font-size: 0.9rem; font-weight: 700; text-align: center; }

        /* --- Scratch Card Logic --- */
        #scratch-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .scratch-container { position: relative; width: 280px; height: 280px; background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 0 40px rgba(255, 153, 51, 0.5); border: 4px solid var(--primary); }
        #scratch-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; z-index: 2; }
        .reward-content { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1; background: radial-gradient(circle, #fff 0%, #fff5e6 100%); }
        .reward-content i { font-size: 3.5rem; color: #ffd700; margin-bottom: 10px; }
        .scratch-hint { margin-top: 15px; color: #fff; font-weight: 600; font-size: 1rem; letter-spacing: 0.5px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        #withdraw-btn { display: none; background: #25d366; color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="scratch-overlay">
        <h2 style="color:var(--primary); margin-bottom: 20px;">Task Complete! </h2>
        <div class="scratch-container">
            <div class="reward-content">
                <i class="fa-solid fa-gift"></i>
                <h2 style="color:var(--dark); font-size: 2.2rem; margin: 0;">3.00</h2>
                <p style="color:#64748b; font-weight:700;">Reward Credited</p>
            </div>
            <canvas id="scratch-canvas" width="280" height="280"></canvas>
        </div>
        <div class="scratch-hint"><i class="fa-solid fa-hand-pointer"></i> Scratch the card to see reward</div>
        <button id="close-scratch" class="btn-save" style="width:220px; margin-top:25px; display:none;" onclick="closeScratch()">Collect & Continue</button>
    </div>

    <nav class="navbar">
        <div style="font-weight: 900; letter-spacing: -0.5px;">ARHAM <span style="color:var(--primary)">INSIGHTS</span></div>
        <button onclick="logout()" style="background:rgba(255,255,255,0.1); border:none; color:white; padding:6px 15px; border-radius:8px; font-size:0.8rem;">Logout</button>
    </nav>

    <div class="container">
        <div class="welcome-card">
            <h2 style="margin:0">Namaste!</h2>
            <p id="user-email-header" style="opacity: 0.7; font-size: 0.9rem; margin: 5px 0 0 0;">Loading profile...</p>
            <div class="stats-row">
                <div class="stat-item"><span>Tasks Done</span><b id="tasks-count">0</b></div>
                <div class="stat-item"><span>Total Balance</span><b id="total-earning">0</b></div>
            </div>
            <button id="withdraw-btn" onclick="sendWhatsAppAlert()"><i class="fa-brands fa-whatsapp"></i> Withdraw 10,000 Now</button>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-user-shield"></i> Profile & Payment Info</div>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <div class="input-group">
                    <label>Contact Email (Verification Ke Liye)</label>
                    <input type="email" id="contact_email" placeholder="Email daalein" required>
                </div>
                <div class="input-group">
                    <label>WhatsApp Number</label>
                    <input type="tel" id="whatsapp_no" placeholder="WhatsApp no. daalein" required>
                </div>
                <div class="input-group">
                    <label>UPI ID (Payment Ke Liye)</label>
                    <input type="text" id="upi_id" placeholder="UPI ID daalein" required>
                </div>
                <button type="submit" id="save-btn" class="btn-save">Save & Lock Details</button>
                <button type="button" id="edit-btn" onclick="enableEditing()" class="btn-edit">Edit Details</button>
            </form>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-fire"></i> Available Tasks</div>
            <div class="task-grid" id="live-links-list">Loading live tasks...</div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient("https://mkzgmrxakattqgbjnwch.supabase.co", "sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL");
        let currentUserSession = null;
        let currentBalance = 0;

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUserSession = session.user;
                document.getElementById('user-email-header').innerText = currentUserSession.email;
                
                // Fetch progress first to get accurate balance
                await fetchUserProgress();
                await loadProfile();
                await fetchTaskLinks();

                if (new URLSearchParams(window.location.search).get('status') === 'success') {
                    showScratchCard();
                }
            } else { window.location.href = "login.html"; }
        }

        async function loadProfile() {
            const { data } = await _supabase.from('profiles').select('*').eq('email', currentUserSession.email).maybeSingle();
            if(data) {
                document.getElementById('contact_email').value = data.contact_email || '';
                document.getElementById('upi_id').value = data.upi_id || '';
                document.getElementById('whatsapp_no').value = data.whatsapp || '';
                if(data.contact_email && data.upi_id) lockInputs();
            }
        }

        async function saveProfile(e) {
            e.preventDefault();
            const saveBtn = document.getElementById('save-btn');
            saveBtn.innerText = "Syncing...";
            saveBtn.disabled = true;

            const payload = {
                email: currentUserSession.email,
                contact_email: document.getElementById('contact_email').value,
                upi_id: document.getElementById('upi_id').value,
                whatsapp: document.getElementById('whatsapp_no').value,
                wallet_balance: currentBalance
            };

            const { error } = await _supabase.from('profiles').upsert(payload, { onConflict: 'email' });
            if (!error) {
                alert("Details Saved & Locked! ");
                lockInputs();
            } else { alert("Sync Error: " + error.message); }
            
            saveBtn.innerText = "Save & Lock Details";
            saveBtn.disabled = false;
        }

        function lockInputs() {
            document.querySelectorAll('#profile-form input').forEach(i => i.readOnly = true);
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('edit-btn').style.display = 'block';
        }

        function enableEditing() {
            document.querySelectorAll('#profile-form input').forEach(i => i.readOnly = false);
            document.getElementById('save-btn').style.display = 'block';
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('contact_email').focus();
        }

        async function fetchUserProgress() {
            // Calculating total sum from amount column
            const { data } = await _supabase.from('user_work').select('amount').eq('username', currentUserSession.email);
            if(data) {
                document.getElementById('tasks-count').innerText = data.length;
                currentBalance = data.reduce((sum, item) => sum + (item.amount || 0), 0);
                document.getElementById('total-earning').innerText = "" + currentBalance;

                if(currentBalance >= 10000) {
                    document.getElementById('withdraw-btn').style.display = 'block';
                }
            }
        }

        async function fetchTaskLinks() {
            const { data } = await _supabase.from('admin_blogs').select('*').order('created_at', {ascending: false});
            const list = document.getElementById('live-links-list');
            if(data) {
                list.innerHTML = data.map(task => `
                    <div class="task-item">
                        <b>${task.keyword}</b>
                        <a href="taskspage.html?id=${task.id}" class="do-btn">Start Task (Reward Earn Karein)</a>
                    </div>`).join('');
            }
        }

        function sendWhatsAppAlert() {
            const msg = ` *Withdrawal Request*%0A User: ${currentUserSession.email}%0A Balance: ${currentBalance}%0A UPI: ${document.getElementById('upi_id').value}`;
            window.open(`https://wa.me/918769531125?text=${msg}`, '_blank');
        }

        function showScratchCard() {
            const overlay = document.getElementById('scratch-overlay');
            const canvas = document.getElementById('scratch-canvas');
            const ctx = canvas.getContext('2d');
            overlay.style.display = 'flex';

            // Orange Scratch Layer
            ctx.fillStyle = '#ff9933';
            ctx.fillRect(0, 0, 280, 280);
            
            ctx.fillStyle = "#ffffff";
            ctx.font = "bold 24px Inter";
            ctx.textAlign = "center";
            ctx.fillText("SCRATCH ME", 140, 150);
            
            let isDrawing = false;
            let scratched = 0;

            const scratch = (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.pageX || (e.touches ? e.touches[0].pageX : 0)) - rect.left;
                const y = (e.pageY || (e.touches ? e.touches[0].pageY : 0)) - rect.top;
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath(); ctx.arc(x, y, 35, 0, Math.PI * 2); ctx.fill();
                scratched++;
                if (scratched > 60) document.getElementById('close-scratch').style.display = 'block';
            };

            canvas.addEventListener('mousedown', () => isDrawing = true);
            canvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); });
            window.addEventListener('mouseup', () => isDrawing = false);
            window.addEventListener('touchend', () => isDrawing = false);
            canvas.addEventListener('mousemove', scratch);
            canvas.addEventListener('touchmove', (e) => { scratch(e); e.preventDefault(); });
        }

        function closeScratch() {
            window.history.replaceState({}, '', window.location.pathname);
            document.getElementById('scratch-overlay').style.display = 'none';
            // Refresh to update wallet after collection
            location.reload();
        }

        async function logout() { await _supabase.auth.signOut(); window.location.href = "login.html"; }
        window.onload = init;
    </script>
</body>
</html>

