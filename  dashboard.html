<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Arham Insights</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary: #ff9933; --dark: #0f172a; --bg: #f8fafc; --success: #22c55e; --secondary: #ef4444; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: #1e293b; margin: 0; padding-bottom: 50px; }
        
        .navbar { background: var(--dark); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .container { max-width: 700px; margin: 20px auto; padding: 0 15px; }

        .welcome-card { background: linear-gradient(135deg, var(--dark) 0%, #1e293b 100%); color: white; padding: 30px; border-radius: 24px; margin-bottom: 25px; position: relative; overflow: hidden; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center; }
        .stat-item b { font-size: 1.4rem; color: var(--primary); display: block; }

        .glass-panel { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { font-weight: 800; font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .section-title i { color: var(--primary); }

        /* Note Style */
        .info-note { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 20px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .info-note p { font-size: 0.85rem; color: #92400e; font-weight: 600; margin: 0; }

        .charge-box { background: #fff1f2; border: 1.5px dashed var(--secondary); padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #f1f5f9; }
        .history-item:last-child { border-bottom: none; }
        .status-badge { background: #dcfce7; color: #166534; font-size: 0.75rem; padding: 4px 12px; border-radius: 50px; font-weight: 700; display: flex; align-items: center; gap: 5px; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #64748b; }
        .input-group input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #f1f5f9; background: #f8fafc; font-size: 1rem; transition: 0.3s; }
        .input-group input:read-only { background: #e2e8f0; color: #475569; border-color: #cbd5e0; cursor: not-allowed; }

        .btn-save { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .btn-edit { background: white; color: var(--dark); border: 2px solid var(--dark); width: 100%; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; display: none; }

        .task-grid { display: grid; gap: 15px; }
        .task-item { background: white; padding: 20px; border-radius: 20px; border: 1px solid #f1f5f9; display: flex; flex-direction: column; gap: 10px; }
        .do-btn { flex: 1; background: var(--primary); color: white; padding: 12px; border-radius: 10px; text-decoration: none; font-size: 0.9rem; font-weight: 700; text-align: center; }

        #scratch-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .scratch-container { position: relative; width: 280px; height: 280px; background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 0 40px rgba(255, 153, 51, 0.5); border: 4px solid var(--primary); }
        #scratch-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; z-index: 2; }
        .reward-content { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1; background: radial-gradient(circle, #fff 0%, #fff5e6 100%); }
        
        #withdraw-btn { display: none; background: #25d366; color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="scratch-overlay">
        <h2 style="color:var(--primary); margin-bottom: 20px;">Task Complete! ðŸš€</h2>
        <div class="scratch-container">
            <div class="reward-content">
                <i class="fa-solid fa-gift" style="font-size: 3.5rem; color: #ffd700; margin-bottom: 10px;"></i>
                <h2 style="color:var(--dark); font-size: 2.2rem; margin: 0;">â‚¹5.00</h2>
                <p style="color:#64748b; font-weight:700;">Reward Credited</p>
            </div>
            <canvas id="scratch-canvas" width="280" height="280"></canvas>
        </div>
        <div class="scratch-hint" style="margin-top: 15px; color: #fff; font-weight: 600;">Scratch the card to see reward</div>
        <button id="close-scratch" class="btn-save" style="width:220px; margin-top:25px; display:none;" onclick="closeScratch()">Collect & Continue</button>
    </div>

    <nav class="navbar">
        <div style="font-weight: 900; letter-spacing: -0.5px;">ARHAM <span style="color:var(--primary)">INSIGHTS</span></div>
        <button onclick="logout()" style="background:rgba(255,255,255,0.1); border:none; color:white; padding:6px 15px; border-radius:8px; font-size:0.8rem;">Logout</button>
    </nav>

    <div class="container">
        <div class="welcome-card">
            <h2 style="margin:0">Namaste!</h2>
            <p id="user-email-header" style="opacity: 0.7; font-size: 0.9rem; margin: 5px 0 0 0;">Loading profile...</p>
            <div class="stats-row">
                <div class="stat-item"><span>Tasks Done</span><b id="tasks-count">0</b></div>
                <div class="stat-item"><span>Total Earning</span><b id="total-earning">â‚¹0</b></div>
            </div>
            <button id="withdraw-btn" onclick="sendWhatsAppAlert()"></button>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-file-invoice-dollar"></i> Payout Summary</div>
            <div class="charge-box">
                <div class="charge-info">
                    <span style="font-size: 0.8rem; color: #64748b; display: block;">Maintenance Fee (Deducted from your payment will shown here )</span>
                    <b style="color: var(--secondary);">â‚¹ 0 </b>
                </div>
                <i class="fa-solid fa-shield-halved" style="color: var(--secondary); font-size: 1.5rem;"></i>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px;">
                <span style="font-weight: 700;">Net Payable Amount:</span>
                <b id="net-payable" style="color: var(--success); font-size: 1.2rem;">â‚¹0.00</b>
            </div>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-clock-rotate-left"></i> Payout History</div>
            <div id="payout-history-list">
                <p style="text-align:center; font-size:0.85rem; color:#94a3b8;">Loading history...</p>
            </div>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-user-shield"></i> Profile & Payment Info</div>
            
            <div class="info-note">
                <i class="fa-solid fa-circle-exclamation" style="color: #f59e0b;"></i>
                <p>Fill all your details correctly for smooth verification.</p>
            </div>

            <form id="profile-form" onsubmit="saveProfile(event)">
                <div class="input-group">
                    <label>Personal Email Address</label>
                    <input type="email" id="contact_email" placeholder="Email address daalein" required>
                </div>
                <div class="input-group">
                    <label>WhatsApp Number</label>
                    <input type="tel" id="whatsapp_no" placeholder="WhatsApp no. daalein" required>
                </div>
                <div class="input-group">
                    <label>UPI ID (For Payments)</label>
                    <input type="text" id="upi_id" placeholder="UPI ID daalein" required>
                </div>
                <button type="submit" id="save-btn" class="btn-save">Save & Lock Details</button>
                <button type="button" id="edit-btn" onclick="enableEditing()" class="btn-edit">Edit Details</button>
            </form>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-fire"></i> Available Tasks</div>
            <div class="task-grid" id="live-links-list">Loading live tasks...</div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient("https://mkzgmrxakattqgbjnwch.supabase.co", "sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL");
        let currentUserSession = null;
        let currentBalance = 0;
        const MAINTENANCE_FEE = 1500;

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUserSession = session.user;
                document.getElementById('user-email-header').innerText = currentUserSession.email;
                await fetchUserProgress();
                await loadProfile();
                await fetchTaskLinks();
                await fetchPayoutHistory();
                if (new URLSearchParams(window.location.search).get('status') === 'success') showScratchCard();
            } else { window.location.href = "login.html"; }
        }

        async function fetchUserProgress() {
            const { data } = await _supabase.from('user_work').select('amount').eq('username', currentUserSession.email);
            if(data) {
                document.getElementById('tasks-count').innerText = data.length;
                currentBalance = data.reduce((sum, item) => sum + (item.amount || 0), 0);
                document.getElementById('total-earning').innerText = "â‚¹" + currentBalance;

                let netPayable = Math.max(0, currentBalance - MAINTENANCE_FEE);
                document.getElementById('net-payable').innerText = "â‚¹" + netPayable.toFixed(2);

                if(currentBalance >= 10000) {
                    const wBtn = document.getElementById('withdraw-btn');
                    wBtn.style.display = 'block';
                    wBtn.innerHTML = `<i class="fa-brands fa-whatsapp"></i> Withdraw Net: â‚¹${netPayable}`;
                }
            }
        }

        async function fetchPayoutHistory() {
            const list = document.getElementById('payout-history-list');
            const { data, error } = await _supabase.from('payout_history').select('*').eq('user_email', currentUserSession.email).order('paid_at', { ascending: false });
            if (data && data.length > 0) {
                list.innerHTML = data.map(item => `
                    <div class="history-item">
                        <div>
                            <b style="font-size:0.95rem;">â‚¹${item.amount}</b>
                            <span style="display:block; font-size:0.7rem; color:#94a3b8;">${new Date(item.paid_at).toLocaleDateString()}</span>
                        </div>
                        <div class="status-badge"><i class="fa-solid fa-circle-check"></i> ${item.status}</div>
                    </div>`).join('');
            } else {
                list.innerHTML = `<p style="text-align:center; font-size:0.8rem; color:#94a3b8;">Abhi tak koi payout nahi hua hai.</p>`;
            }
        }

        async function loadProfile() {
            const { data } = await _supabase.from('profiles').select('*').eq('email', currentUserSession.email).maybeSingle();
            if(data) {
                document.getElementById('contact_email').value = data.contact_email || '';
                document.getElementById('upi_id').value = data.upi_id || '';
                document.getElementById('whatsapp_no').value = data.whatsapp || '';
                if(data.upi_id) lockInputs();
            }
        }

        async function saveProfile(e) {
            e.preventDefault();
            const payload = {
                email: currentUserSession.email,
                contact_email: document.getElementById('contact_email').value,
                upi_id: document.getElementById('upi_id').value,
                whatsapp: document.getElementById('whatsapp_no').value,
                wallet_balance: currentBalance
            };
            const { error } = await _supabase.from('profiles').upsert(payload, { onConflict: 'email' });
            if (!error) { alert("Details Saved! ðŸš€"); lockInputs(); }
        }

        function lockInputs() {
            document.querySelectorAll('#profile-form input').forEach(i => i.readOnly = true);
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('edit-btn').style.display = 'block';
        }

        function enableEditing() {
            document.querySelectorAll('#profile-form input').forEach(i => i.readOnly = false);
            document.getElementById('save-btn').style.display = 'block';
            document.getElementById('edit-btn').style.display = 'none';
        }

        async function fetchTaskLinks() {
            const { data } = await _supabase.from('admin_blogs').select('*').order('created_at', {ascending: false});
            const list = document.getElementById('live-links-list');
            if(data) {
                list.innerHTML = data.map(task => `
                    <div class="task-item">
                        <b>${task.keyword}</b>
                        <a href="taskspage.html?id=${task.id}" class="do-btn">Start Task (Reward Earn Karein)</a>
                    </div>`).join('');
            }
        }

        function sendWhatsAppAlert() {
            let netPayable = currentBalance - MAINTENANCE_FEE;
            const msg = `ðŸš€ *Withdrawal Request*%0AðŸ‘¤ User: ${currentUserSession.email}%0AðŸ’° Total Balance: â‚¹${currentBalance}%0AðŸ›  Fee: â‚¹${MAINTENANCE_FEE}%0AðŸ’µ Net Payable: â‚¹${netPayable}%0AðŸ’³ UPI: ${document.getElementById('upi_id').value}`;
            window.open(`https://wa.me/918769531125?text=${msg}`, '_blank');
        }

        function showScratchCard() {
            const overlay = document.getElementById('scratch-overlay');
            const canvas = document.getElementById('scratch-canvas');
            const ctx = canvas.getContext('2d');
            overlay.style.display = 'flex';
            ctx.fillStyle = '#ff9933'; ctx.fillRect(0, 0, 280, 280);
            ctx.fillStyle = "#ffffff"; ctx.font = "bold 24px Inter"; ctx.textAlign = "center"; ctx.fillText("SCRATCH ME", 140, 150);
            let isDrawing = false; let scratched = 0;
            const scratch = (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.pageX || (e.touches ? e.touches[0].pageX : 0)) - rect.left;
                const y = (e.pageY || (e.touches ? e.touches[0].pageY : 0)) - rect.top;
                ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(x, y, 35, 0, Math.PI * 2); ctx.fill();
                scratched++; if (scratched > 60) document.getElementById('close-scratch').style.display = 'block';
            };
            canvas.addEventListener('mousedown', () => isDrawing = true);
            canvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); });
            window.addEventListener('mouseup', () => isDrawing = false);
            window.addEventListener('touchend', () => isDrawing = false);
            canvas.addEventListener('mousemove', scratch);
            canvas.addEventListener('touchmove', (e) => { scratch(e); e.preventDefault(); });
        }

        function closeScratch() { window.history.replaceState({}, '', window.location.pathname); location.reload(); }
        async function logout() { await _supabase.auth.signOut(); window.location.href = "login.html"; }
        window.onload = init;
    </script>
</body>
</html>
