<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Arham Insights</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary: #ff9933; --dark: #0f172a; --bg: #f8fafc; --success: #22c55e; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: #1e293b; margin: 0; padding-bottom: 50px; }
        
        .navbar { background: var(--dark); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .container { max-width: 700px; margin: 20px auto; padding: 0 15px; }

        .welcome-card { background: linear-gradient(135deg, var(--dark) 0%, #1e293b 100%); color: white; padding: 30px; border-radius: 24px; margin-bottom: 25px; position: relative; overflow: hidden; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center; }
        .stat-item b { font-size: 1.4rem; color: var(--primary); display: block; }

        .glass-panel { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { font-weight: 800; font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .section-title i { color: var(--primary); }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #64748b; }
        .input-group input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #f1f5f9; background: #f8fafc; font-size: 1rem; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); outline: none; background: white; }
        .input-group input:read-only { background: #e2e8f0; color: #475569; border-color: #cbd5e0; cursor: not-allowed; }

        .btn-save { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(255, 153, 51, 0.3); }
        .btn-edit { background: white; color: var(--dark); border: 2px solid var(--dark); width: 100%; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; display: none; transition: 0.3s; }

        .note-alert { background: #fff1f2; border: 1px solid #fecdd3; padding: 15px; border-radius: 15px; display: flex; gap: 12px; color: #9f1239; font-size: 0.85rem; margin-bottom: 25px; }

        /* Sync Logic Styles */
        .task-grid { display: grid; gap: 15px; }
        .task-item { background: white; padding: 20px; border-radius: 20px; border: 1px solid #f1f5f9; display: flex; flex-direction: column; gap: 10px; }
        .task-meta { display: flex; justify-content: space-between; align-items: center; }
        .task-actions { display: flex; gap: 10px; }
        
        .copy-btn { flex: 1; background: #f1f5f9; color: var(--dark); border: 1px solid #e2e8f0; padding: 10px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 0.85rem; }
        .do-btn { flex: 1; background: var(--primary); color: white; padding: 10px; border-radius: 10px; text-decoration: none; font-size: 0.85rem; font-weight: 700; text-align: center; }
        
        #loader { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loader">
        <img src="https://arhaminsightses.netlify.app/logo.png" width="70" style="border-radius:15px; margin-bottom: 10px;">
        <p style="font-weight: 700; color: var(--primary);">Syncing Your Dashboard...</p>
    </div>

    <nav class="navbar">
        <div style="font-weight: 900; letter-spacing: -0.5px;">ARHAM <span style="color:var(--primary)">INSIGHTS</span></div>
        <button onclick="logout()" style="background:rgba(255,255,255,0.1); border:none; color:white; padding:6px 15px; border-radius:8px; font-size:0.8rem;">Logout</button>
    </nav>

    <div class="container">
        <div class="welcome-card">
            <h2 style="margin:0">Namaste!</h2>
            <p id="user-email-header" style="opacity: 0.7; font-size: 0.9rem; margin: 5px 0 0 0;">Welcome to Arham Insights</p>
            <div class="stats-row">
                <div class="stat-item"><span>Tasks Done</span><b id="tasks-count">0</b></div>
                <div class="stat-item"><span>Total Balance</span><b id="total-earning">₹0</b></div>
            </div>
        </div>

        <div class="note-alert">
            <i class="fa-solid fa-circle-exclamation"></i>
            <span><b>Dhyan Dein:</b> Email, WhatsApp aur UPI sahi bharein. Har task se ₹5 ki earning hogi.</span>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-user-shield"></i> Profile & Payment Info</div>
            <form id="profile-form" onsubmit="saveProfile(event)">
                <div class="input-group">
                    <label>Registered Email</label>
                    <input type="email" id="contact_email" placeholder="Email manually fill karein" required>
                </div>
                <div class="input-group">
                    <label>WhatsApp Number</label>
                    <input type="tel" id="whatsapp_no" placeholder="WhatsApp Number fill karein" required>
                </div>
                <div class="input-group">
                    <label>UPI ID (For Payments)</label>
                    <input type="text" id="upi_id" placeholder="UPI ID fill karein" required>
                </div>
                <button type="submit" id="save-btn" class="btn-save">Save & Lock Details</button>
            </form>
            <button id="edit-btn" onclick="enableEditing()" class="btn-edit"><i class="fa-solid fa-pen-to-square"></i> Edit Details</button>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-fire"></i> Available Tasks</div>
            <div class="task-grid" id="live-links-list">
                <p style="text-align:center; color:#94a3b8;">Loading live tasks...</p>
            </div>
        </div>

        <div class="glass-panel">
            <div class="section-title"><i class="fa-solid fa-list-check"></i> Work Progress</div>
            <div id="history-list" style="font-size: 0.9rem; color: #64748b;">No tasks submitted yet.</div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient("https://mkzgmrxakattqgbjnwch.supabase.co", "sb_publishable_Div0TjlgvUbXNlwVqNGuag_-dPli5uL");
        let currentUserSession = null;

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUserSession = session.user;
                document.getElementById('user-email-header').innerText = currentUserSession.email;
                await loadProfile();
                await fetchTaskLinks(); // Yahi function admin ke links sync karega
                await fetchUserProgress();
                document.getElementById('loader').style.display = 'none';
            } else { window.location.href = "login.html"; }
        }

        // Profile Logic (Preserved from your code)
        async function loadProfile() {
            const { data } = await _supabase.from('profiles').select('*').eq('email', currentUserSession.email).maybeSingle();
            if(data && (data.contact_email || data.upi_id || data.whatsapp)) {
                document.getElementById('contact_email').value = data.contact_email || '';
                document.getElementById('upi_id').value = data.upi_id || '';
                document.getElementById('whatsapp_no').value = data.whatsapp || '';
                lockInputs();
            }
        }

        async function saveProfile(e) {
            e.preventDefault();
            const manualEmail = document.getElementById('contact_email').value;
            const upi = document.getElementById('upi_id').value;
            const wa = document.getElementById('whatsapp_no').value;
            const { error } = await _supabase.from('profiles').upsert([
                { email: currentUserSession.email, contact_email: manualEmail, upi_id: upi, whatsapp: wa }
            ], { onConflict: 'email' });
            if (!error) { alert("Details Saved! ✅"); lockInputs(); }
        }

        function lockInputs() {
            document.getElementById('contact_email').readOnly = true;
            document.getElementById('upi_id').readOnly = true;
            document.getElementById('whatsapp_no').readOnly = true;
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('edit-btn').style.display = 'block';
        }

        function enableEditing() {
            document.getElementById('contact_email').readOnly = false;
            document.getElementById('upi_id').readOnly = false;
            document.getElementById('whatsapp_no').readOnly = false;
            document.getElementById('save-btn').style.display = 'block';
            document.getElementById('edit-btn').style.display = 'none';
        }

        // --- TASK SYNC LOGIC ---
        async function fetchTaskLinks() {
            // Admin panel wali table 'admin_blogs' se saare tasks fetch karna
            const { data, error } = await _supabase.from('admin_blogs').select('*').order('created_at', {ascending: false});
            const list = document.getElementById('live-links-list');
            
            if(data && data.length > 0) {
                list.innerHTML = data.map(task => {
                    // Unique link generate karna
                    const taskUrl = `https://arhaminsightses.netlify.app/taskspage.html?id=${task.id}`;
                    
                    return `
                        <div class="task-item">
                            <div class="task-meta">
                                <b>${task.keyword}</b>
                                <small style="color:var(--success); font-weight:700;">₹5 Reward</small>
                            </div>
                            <div class="task-actions">
                                <button class="copy-btn" onclick="copyToClipboard('${taskUrl}')">
                                    <i class="fa fa-copy"></i> Copy Task Link
                                </button>
                                <a href="${taskUrl}" class="do-btn">Start Task</a>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8;">Naye tasks jald hi aayenge...</p>';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("Link Copied! ✅ Isse browser mein open karke task poora karein.");
            });
        }

        async function fetchUserProgress() {
            const { data } = await _supabase.from('user_work').select('*').eq('username', currentUserSession.email);
            if(data && data.length > 0) {
                document.getElementById('tasks-count').innerText = data.length;
                document.getElementById('total-earning').innerText = "₹" + (data.length * 5);
                document.getElementById('history-list').innerHTML = data.map(item => `
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9; padding:10px 0;">
                        <span>Task ID: #${item.task_id}</span>
                        <span style="color:orange; font-weight:700">${item.status}</span>
                    </div>
                `).join('');
            }
        }

        async function logout() { await _supabase.auth.signOut(); window.location.href = "login.html"; }
        window.onload = init;
    </script>
</body>
</html>
